<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="google-site-verification" content="TZE0rZyIqLl10trYu3BWBWa1Vmz6HFwhb2OcNEK4u-s" />
     <link rel="shortcut icon" href= /img/favicon.ico >
    <title>
        Do Not Repeat!
    </title>
    <meta name="description" content= shudo's new blog >
    <meta name="keywords" content= Blog,Hexo,Theme >
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>
<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-home
 replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            Forecast &#34;future&#34; with TDengine
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h1 id="Forecast-“future”-with-TDengine"><a href="#Forecast-“future”-with-TDengine" class="headerlink" title="Forecast “future” with TDengine"></a>Forecast “future” with TDengine</h1><h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>TDengine™ is an open-source, cloud-native time series database (TSDB) optimized for the Internet of Things (IoT), Connected Cars, and Industrial IoT. It enables efficient, real-time ingestion, processing, and monitoring of petabytes of data per day, generated by billions of sensors and data collectors. </p>
<p>There are many users storing massive data generated by IoT devices, cars, or IT infrastructures into TDengine in real-time. They use standard SQL commands to query the data from TDengine. TDengine supports filter, group, windowed, join, and many aggregation functions to query data. It facilitates users to query data according to their purpose.</p>
<p>Many users also want to get more interested in existing data. For example, what would happen in light of the current trend? With the AI era coming, there are many new technologies or methods emerging in recent years, such as new machine learning, and deep learning algorithms. Is it possible to use machine learning and deep learning algorithms to forecast the future with the data stored in the TDengine cluster?</p>
<p>Fortunately, TDengine supports multiple popular programming language connectors like Java, Python, Go, Rust, C#, NodeJS, etc. Users can use their favorite language connector to access TDengine. The connectors provide interfaces that conform to the specification. That makes connectors easily integrated with other software or frameworks.</p>
<p>This article introduces how to forecast future data with existing data stored in the TDengine. We will mock some test data to reflect a real power system. And demonstrate how to use TDengine and a few Python libraries to forecast how the data will be in the next year.</p>
<p>Suppose the user is an electrical power system company. The user collects the power consumption number from the electricity station meter each day and stores it in a TDengine cluster. Now the user wants to forecast the power consumption will be and to purchase more devices to support it.</p>
<p>As the economy grows, electricity consumption increases by a certain percentage each year. In addition, considering the seasonal variations, electricity consumption varies accordingly. This city is located in the northern hemisphere, so many households use more electricity in the summer. We simulate data to reflect these assumptions</p>
<p>The source code is hosted at <a target="_blank" rel="noopener" href="https://github.com/sangshuduo/td-forecasting">https://github.com/sangshuduo/td-forecasting</a>.</p>
<h2 id="Demonstration"><a href="#Demonstration" class="headerlink" title="Demonstration"></a>Demonstration</h2><h3 id="Step-1-Deploy-TDengine-and-run-the-TDengine-server-on-your-system"><a href="#Step-1-Deploy-TDengine-and-run-the-TDengine-server-on-your-system" class="headerlink" title="Step 1: Deploy TDengine and run the TDengine server on your system"></a>Step 1: Deploy TDengine and run the TDengine server on your system</h3><p>Please refer to the official document <a target="_blank" rel="noopener" href="https://docs.tdengine.com/get-started/">https://docs.tdengine.com/get-started/</a> for detailed instructions.</p>
<h3 id="Step-2-Clone-source-code"><a href="#Step-2-Clone-source-code" class="headerlink" title="Step 2: Clone source code"></a>Step 2: Clone source code</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/sangshuduo/td-forecasting</span><br></pre></td></tr></table></figure>

<h3 id="Step-3-Install-the-required-Python-packages"><a href="#Step-3-Install-the-required-Python-packages" class="headerlink" title="Step 3: Install the required Python packages"></a>Step 3: Install the required Python packages</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># if you are using Ubuntu 20.04 Linux</span><br><span class="line">sudo apt install python3-pyqt5</span><br><span class="line"></span><br><span class="line"># Optional, if PyQT5 fails</span><br><span class="line">sudo apt-get install libxcb-xinerama0</span><br><span class="line"></span><br><span class="line">python3 -m pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>Please note minimal required Python version is 3.8.</p>
<h3 id="Step-4-Mock-some-data"><a href="#Step-4-Mock-some-data" class="headerlink" title="Step 4: Mock some data"></a>Step 4: Mock some data</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 mockdata.py</span><br></pre></td></tr></table></figure>

<h3 id="Step-5-Forecast-next-year’s-data"><a href="#Step-5-Forecast-next-year’s-data" class="headerlink" title="Step 5: Forecast next year’s data"></a>Step 5: Forecast next year’s data</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 forecast.py</span><br></pre></td></tr></table></figure>

<h3 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h3><p>If everything is okay, the figure will show up like below.</p>
<p><img src="output.png" alt="Image"></p>
<h2 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work?"></a>How does it work?</h2><h3 id="mockdata-py"><a href="#mockdata-py" class="headerlink" title="mockdata.py"></a>mockdata.py</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def insert_rec_per_month(conn, db_name, table_name, year, month):</span><br><span class="line">    increment = (year - 2014) * 1.1</span><br><span class="line">    base = int(10 * increment)</span><br><span class="line">    if month &lt; 10 and month &gt; 5:</span><br><span class="line">        factor = 10</span><br><span class="line">    else:</span><br><span class="line">        factor = 8</span><br><span class="line">    for day in range(1, monthrange(year, month)[1] + 1):</span><br><span class="line">        num = base * randint(5, factor) + randint(0, factor)</span><br><span class="line">        sql = f&quot;INSERT INTO &#123;db_name&#125;.&#123;table_name&#125; VALUES (&#x27;&#123;year&#125;-&#123;month&#125;-&#123;day&#125; 00:00:00.000&#x27;, &#123;num&#125;)&quot;</span><br><span class="line">        try:</span><br><span class="line">            conn.execute(sql)</span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(f&quot;command: &#123;sql&#125;&quot;)</span><br><span class="line">            print(e)</span><br></pre></td></tr></table></figure>

<p>The core function of mockdata.py is mocking random data with a few adjustments to fulfill the assumption. </p>
<h3 id="forecast-py"><a href="#forecast-py" class="headerlink" title="forecast.py"></a>forecast.py</h3><p>The forecast.py implements the forecasting function.</p>
<h4 id="Step1-Import-necessary-modules-for-prediction"><a href="#Step1-Import-necessary-modules-for-prediction" class="headerlink" title="Step1: Import necessary modules for prediction"></a>Step1: Import necessary modules for prediction</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import argparse</span><br><span class="line"></span><br><span class="line">import lightgbm as lgb</span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">import mlforecast</span><br><span class="line">import pandas as pd</span><br><span class="line">from mlforecast.target_transforms import Differences</span><br><span class="line">from sklearn.linear_model import LinearRegression</span><br><span class="line">from sqlalchemy import create_engine, text</span><br></pre></td></tr></table></figure>

<p>Here explain what they are and what they are for.</p>
<ul>
<li>Lightgbm is a Python module that supports the LightGBM algorithm, a gradient-boosting framework that uses tree-based learning algorithms.</li>
<li>Matplotlib is one of the most popular Python modules for visualization.</li>
<li>Mlforecast is a framework to perform time series forecasting using machine learning models.</li>
<li>Pandas is the most popular module to support data manipulation. </li>
<li>Sklearn is a module that supports popular data science/machine learning algorithms.</li>
<li>SQLAlchemy is the Python SQL toolkit and Object Relational Mapper that gives application developers the full power and flexibility of SQL.</li>
</ul>
<h4 id="Step-2-Connect-to-TDengine-and-query-data"><a href="#Step-2-Connect-to-TDengine-and-query-data" class="headerlink" title="Step 2: Connect to TDengine and query data"></a>Step 2: Connect to TDengine and query data</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">engine = create_engine(&quot;taos://root:taosdata@localhost:6030/power&quot;)</span><br><span class="line">conn = engine.connect()</span><br><span class="line">print(&quot;Connected to the TDengine ...&quot;)</span><br><span class="line">df = pd.read_sql(</span><br><span class="line">    text(&quot;select _wstart as ds, avg(num) as y from power.meters interval(1w)&quot;), conn</span><br><span class="line">)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>TDengine Python connector complies with Python Database API Specification v2.0 (PEP 249). DBAPI is shorthand for the phrase “Python Database API Specification”. This is a widely used specification within Python to define common usage patterns for all database connection packages. The DBAPI is a “low level” API which is typically the lowest level system used in a Python application to talk to a database. SQLAlchemy’s dialect system is constructed around the operation of the DBAPI, providing individual dialect classes which service a specific DBAPI on top of a specific database engine.</p>
<p>We can use SQLAlchemy to connect the TDengine cluster and use Pandas to query data to data frame format.</p>
<p>Here we suppose the user cares about weekly average power consumption instead of daily consumption to reduce the unusual value. We can use AVG() function and INTERVAL(1w) clause command to query the data from the TDengine cluster.</p>
<p>We will manipulate the data in data frame format later.</p>
<h4 id="Step-3-Forecasting"><a href="#Step-3-Forecasting" class="headerlink" title="Step 3: Forecasting"></a>Step 3: Forecasting</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">df.insert(0, column=&quot;unique_id&quot;, value=&quot;unique_id&quot;)</span><br><span class="line"></span><br><span class="line">print(&quot;Forecasting ...&quot;)</span><br><span class="line">forecast = mlforecast.MLForecast(</span><br><span class="line">    models=[LinearRegression(), lgb.LGBMRegressor()],</span><br><span class="line">    freq=&quot;W&quot;,</span><br><span class="line">    lags=[52],</span><br><span class="line">    target_transforms=[Differences([52])],</span><br><span class="line">)</span><br><span class="line">forecast.fit(df)</span><br><span class="line"></span><br><span class="line">predicts = forecast.predict(52)</span><br><span class="line"></span><br><span class="line">pd.concat([df, predicts]).set_index(&quot;ds&quot;).plot(figsize=(12, 8)) </span><br></pre></td></tr></table></figure>

<p>By the feat of the mlforecast module, we can do the forecasting with few parameters. Here we use linear regression and LightGBM to show their results in the same graph to visualize what the different algorithms made.</p>
<h4 id="Step-4-Show-up-or-dump-to-file"><a href="#Step-4-Show-up-or-dump-to-file" class="headerlink" title="Step 4: Show up or dump to file"></a>Step 4: Show up or dump to file</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if args.dump:</span><br><span class="line">    plt.savefig(args.dump)</span><br><span class="line">else:</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>

<p>The Python code provides an argument –dump to allow users to decide to dump the result into a picture for post-processing or to show up the result on the screen immediately.</p>
<p>The above steps are verified on Ubuntu 20.04, Ubuntu 22.04, Windows 10, and macOS.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>And that’s it! We now have a very simple program to demonstrate how to use TDengine to predict power meter numbers using power system history data stored in TDengine.</p>

    </div>

    
        <hr class="fhr">
        <div id="vcomments"></div>
    
</div>
    <div class="footer" id="footer">
    <p><h4>Copyright © 2020 | Author: Shuduo Sang | Theme By <a class="theme-author" target="_blank" rel="noopener" href="https://github.com/Xunzhuo/hexo-theme-coder" style="font-size:14px; color: #969696">Coder</a></h4>
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">Page Views: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">Unique Visitors: <span id="busuanzi_value_site_uv"></span></span>
    
    <label class="el-switch el-switch-blue el-switch-sm" style="vertical-align: sub;">
        <input type="checkbox" name="switch" id="update_style">
        <span class="el-switch-style"></span>
    </label>

    <!--         <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
    document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script> -->
</p>
</div>

<input type="hidden" id="web_style" value="light">
<input type="hidden" id="valine_appid" value="">
<input type="hidden" id="valine_appKey" value="">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
color: #698fca;
}
.v .vlist .vcard .vhead .vsys {
color: #3a3e4a;
}
.v .vlist .vcard .vh .vmeta .vat {
color: #638fd5;
}
.v .vlist .vcard .vhead .vnick {
color: #6ba1ff;
}
.v a {
color: #8696b1;
}
.v .vlist .vcard .vhead .vnick:hover {
color: #669bfc;
}
</style>
    <script type="text/javascript" color="173,174,173" opacity='1' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
</body>
</html>
